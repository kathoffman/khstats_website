<!DOCTYPE html>
<html lang="en-us">

<head>

  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="generator" content="Source Themes Academic 4.4.0">

  

  
  
  
  
  
    
    
    
  
  

  <meta name="author" content="Katherine Hoffman">

  
  
  
    
  
  <meta name="description" content="TLDR  When performing research on observational data, we often want to accurately and precisely quantify the effect of an exposure, or treatment, on an outcome.
 The most basic form of Targeted Maximum Likelihood Estimation (TMLE) allows you to calculate the average treatment effect using estimates of:
the expected outcome for an individual, given the treatment they received and their baseline confounders
 the probability an individual received the treatment of interest, given their baseline confounders (a propensity score)">

  
  <link rel="alternate" hreflang="en-us" href="/blog/tmle-tutorial/tmle-tutorial-2/">

  


  

  
  
  
  <meta name="theme-color" content="#3f51b5">
  

  
  
  
  
    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/academicons/1.8.6/css/academicons.min.css" integrity="sha256-uFVgMKfistnJAfoCUQigIl+JfUaP47GrRKjf6CTPVmw=" crossorigin="anonymous">
    <link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.6.0/css/all.css" integrity="sha384-aOkxzJ5uQz7WBObEZcHvV5JvRW3TUc2rNPA7pe3AwnsUohiw1Vj2Rgx2KSOkF5+h" crossorigin="anonymous">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/fancybox/3.2.5/jquery.fancybox.min.css" integrity="sha256-ygkqlh3CYSUri3LhQxzdcm0n1EQvH2Y+U5S2idbLtxs=" crossorigin="anonymous">

    
    
    
      
    
    
      
      
        
          <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.15.6/styles/github.min.css" crossorigin="anonymous" title="hl-light">
          <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.15.6/styles/dracula.min.css" crossorigin="anonymous" title="hl-dark" disabled>
        
      
    

    

    

  

  
  
  <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Montserrat:400,700|Roboto:400,400italic,700|Roboto+Mono&display=swap">
  

  
  
  
  <link rel="stylesheet" href="/css/academic.min.3072054fc61fe865aa34bcb366de141d.css">

  

  
  
    <script>
      window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;
      ga('create', 'UA-136820093-1', 'auto');
      
      ga('require', 'eventTracker');
      ga('require', 'outboundLinkTracker');
      ga('require', 'urlChangeTracker');
      ga('send', 'pageview');
    </script>
    <script async src="https://www.google-analytics.com/analytics.js"></script>
    
    <script async src="https://cdnjs.cloudflare.com/ajax/libs/autotrack/2.4.1/autotrack.js" integrity="sha512-HUmooslVKj4m6OBu0OgzjXXr+QuFYy/k7eLI5jdeEy/F4RSgMn6XRWRGkFi5IFaFgy7uFTkegp3Z0XnJf3Jq+g==" crossorigin="anonymous"></script>
    
  
  

  

  <link rel="manifest" href="/index.webmanifest">
  <link rel="icon" type="image/png" href="/img/icon-32.png">
  <link rel="apple-touch-icon" type="image/png" href="/img/icon-192.png">

  <link rel="canonical" href="/blog/tmle-tutorial/tmle-tutorial-2/">

  
  
  
  
    
    
  
  
  <meta property="twitter:card" content="summary">
  
  <meta property="twitter:site" content="@Rkatlady">
  <meta property="twitter:creator" content="@Rkatlady">
  
  <meta property="og:site_name" content="KHstats">
  <meta property="og:url" content="/blog/tmle-tutorial/tmle-tutorial-2/">
  <meta property="og:title" content="An Equation-Free Explanation of Targeted Maximum Likelihood Estimation (TMLE) | KHstats">
  <meta property="og:description" content="TLDR  When performing research on observational data, we often want to accurately and precisely quantify the effect of an exposure, or treatment, on an outcome.
 The most basic form of Targeted Maximum Likelihood Estimation (TMLE) allows you to calculate the average treatment effect using estimates of:
the expected outcome for an individual, given the treatment they received and their baseline confounders
 the probability an individual received the treatment of interest, given their baseline confounders (a propensity score)"><meta property="og:image" content="/img/icon-192.png">
  <meta property="twitter:image" content="/img/icon-192.png"><meta property="og:locale" content="en-us">
  
    
      <meta property="article:published_time" content="2020-01-17T21:13:14-05:00">
    
    <meta property="article:modified_time" content="2020-01-17T21:13:14-05:00">
  

  


  





  <title>An Equation-Free Explanation of Targeted Maximum Likelihood Estimation (TMLE) | KHstats</title>

</head>

<body id="top" data-spy="scroll" data-offset="70" data-target="#TableOfContents" >

  <aside class="search-results" id="search">
  <div class="container">
    <section class="search-header">

      <div class="row no-gutters justify-content-between mb-3">
        <div class="col-6">
          <h1>Search</h1>
        </div>
        <div class="col-6 col-search-close">
          <a class="js-search" href="#"><i class="fas fa-times-circle text-muted" aria-hidden="true"></i></a>
        </div>
      </div>

      <div id="search-box">
        
        <input name="q" id="search-query" placeholder="Search..." autocapitalize="off"
        autocomplete="off" autocorrect="off" spellcheck="false" type="search">
        
      </div>

    </section>
    <section class="section-search-results">

      <div id="search-hits">
        
      </div>

    </section>
  </div>
</aside>


  
<nav class="navbar navbar-light fixed-top navbar-expand-lg py-0 compensate-for-scrollbar" id="navbar-main">
  <div class="container">

    
      <a class="navbar-brand" href="/">KHstats</a>
      
      <button type="button" class="navbar-toggler" data-toggle="collapse"
              data-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
        <span><i class="fas fa-bars"></i></span>
      </button>
      

    
    <div class="collapse navbar-collapse" id="navbar">

      
      
      <ul class="navbar-nav mr-auto">
        

        

        
        
        
          
        

        
        
        
        
        
        
          
          
          
            
          
          
        

        <li class="nav-item">
          <a class="nav-link " href="/#hero"><span>About</span></a>
        </li>

        
        

        

        
        
        
          
        

        
        
        
        
        
        
          
          
          
            
          
          
        

        <li class="nav-item">
          <a class="nav-link " href="/#experience"><span>Experience</span></a>
        </li>

        
        

        

        
        
        
          
        

        
        
        
        
        
        
          
          
          
            
          
          
        

        <li class="nav-item">
          <a class="nav-link " href="/#blogs"><span>Blog</span></a>
        </li>

        
        

        

        
        
        
          
        

        
        
        
        
        
        
          
          
          
            
          
          
        

        <li class="nav-item">
          <a class="nav-link " href="/#talks"><span>Talks</span></a>
        </li>

        
        

        

        
        
        
          
        

        
        
        
        
        
        
          
          
          
            
          
          
        

        <li class="nav-item">
          <a class="nav-link " href="/#contact"><span>Contact</span></a>
        </li>

        
        

      
      </ul>
      <ul class="navbar-nav ml-auto">
      

        

        
        <li class="nav-item">
          <a class="nav-link js-search" href="#"><i class="fas fa-search" aria-hidden="true"></i></a>
        </li>
        

        

        
        <li class="nav-item">
          <a class="nav-link js-dark-toggle" href="#"><i class="fas fa-moon" aria-hidden="true"></i></a>
        </li>
        

      </ul>

    </div>
  </div>
</nav>


  <article class="article" itemscope itemtype="http://schema.org/Article">

  












  

  
  
  
<div class="article-container pt-3">
  <h1 itemprop="name">An Equation-Free Explanation of Targeted Maximum Likelihood Estimation (TMLE)</h1>

  

  
    



<meta content="2020-01-17 21:13:14 -0500 EST" itemprop="datePublished">
<meta content="2020-01-17 21:13:14 -0500 EST" itemprop="dateModified">

<div class="article-metadata">

  
  

  
  <span class="article-date">
    
    
      
    
    <time>Jan 17, 2020</time>
  </span>
  

  

  

  
  
  

  
  
  <span class="middot-divider"></span>
  <span class="article-categories">
    <i class="fas fa-folder mr-1"></i><a href="/categories/r/">R</a></span>
  

  
    
<div class="share-box" aria-hidden="true">
  <ul class="share">
    
      
      
      
        
      
      
      
      <li>
        <a href="https://twitter.com/intent/tweet?url=/blog/tmle-tutorial/tmle-tutorial-2/&amp;text=An%20Equation-Free%20Explanation%20of%20Targeted%20Maximum%20Likelihood%20Estimation%20%28TMLE%29" target="_blank" rel="noopener" class="share-btn-twitter">
          <i class="fab fa-twitter"></i>
        </a>
      </li>
    
      
      
      
        
      
      
      
      <li>
        <a href="https://www.facebook.com/sharer.php?u=/blog/tmle-tutorial/tmle-tutorial-2/&amp;t=An%20Equation-Free%20Explanation%20of%20Targeted%20Maximum%20Likelihood%20Estimation%20%28TMLE%29" target="_blank" rel="noopener" class="share-btn-facebook">
          <i class="fab fa-facebook-f"></i>
        </a>
      </li>
    
      
      
      
        
      
      
      
      <li>
        <a href="mailto:?subject=An%20Equation-Free%20Explanation%20of%20Targeted%20Maximum%20Likelihood%20Estimation%20%28TMLE%29&amp;body=/blog/tmle-tutorial/tmle-tutorial-2/" target="_blank" rel="noopener" class="share-btn-email">
          <i class="fas fa-envelope"></i>
        </a>
      </li>
    
      
      
      
        
      
      
      
      <li>
        <a href="https://www.linkedin.com/shareArticle?url=/blog/tmle-tutorial/tmle-tutorial-2/&amp;title=An%20Equation-Free%20Explanation%20of%20Targeted%20Maximum%20Likelihood%20Estimation%20%28TMLE%29" target="_blank" rel="noopener" class="share-btn-linkedin">
          <i class="fab fa-linkedin-in"></i>
        </a>
      </li>
    
      
      
      
        
      
      
      
      <li>
        <a href="https://web.whatsapp.com/send?text=An%20Equation-Free%20Explanation%20of%20Targeted%20Maximum%20Likelihood%20Estimation%20%28TMLE%29%20/blog/tmle-tutorial/tmle-tutorial-2/" target="_blank" rel="noopener" class="share-btn-whatsapp">
          <i class="fab fa-whatsapp"></i>
        </a>
      </li>
    
      
      
      
        
      
      
      
      <li>
        <a href="https://service.weibo.com/share/share.php?url=/blog/tmle-tutorial/tmle-tutorial-2/&amp;title=An%20Equation-Free%20Explanation%20of%20Targeted%20Maximum%20Likelihood%20Estimation%20%28TMLE%29" target="_blank" rel="noopener" class="share-btn-weibo">
          <i class="fab fa-weibo"></i>
        </a>
      </li>
    
  </ul>
</div>


  

</div>

    














  
</div>



  <div class="article-container">

    <div class="article-style" itemprop="articleBody">
      


<hr />
<div id="tldr" class="section level1">
<h1>TLDR</h1>
<ul>
<li><p>When performing research on observational data, we often want to accurately and precisely quantify the effect of an exposure, or treatment, on an outcome.</p></li>
<li><p>The most basic form of Targeted Maximum Likelihood Estimation (TMLE) allows you to calculate the average treatment effect using estimates of:</p>
<ol style="list-style-type: decimal">
<li><p>the expected outcome for an individual, given the treatment they received and their baseline confounders</p></li>
<li><p>the probability an individual received the treatment of interest, given their baseline confounders (a propensity score)</p></li>
</ol></li>
<li><p>These estimates can come from any estimator(s) (such as a parametric or non-parametric model, or ensemble learning methods), but the final estimate of the average treatment effect will still have valid confidence intervals.</p></li>
<li><p>Additionally, that final estimate is unbiased, with an optimized bias-variance tradeoff. The estimate will remain unbiased even if one of the two estimating equations are incorrect.</p></li>
<li><p>The TMLE algorithm can be understood <a href="#the-tmle-algorithm">through a series of steps</a>. The <code>R</code> packages <code>tmle</code> or <code>tmle3</code> make it <a href="#a-real-world-application-of-tmle">easy to quickly implement TMLE</a>.</p></li>
</ul>
<hr />
<p>I have spent the past year learning and implementing causal inference methods as a Masters-level biostatistician, and I am excited to share my favorite method for estimation: Targeted Maximum Likelihood Estimation (TMLE). I have tried to explain at the minimum level I think is necessary for an applied statistician to understand and implement TMLE, in hopes that others will feel empowered to try it out.</p>
<p><em>Disclaimer:</em> There is are very few equations in this post‚Ä¶üòá I understand best with words, visuals, and code, so that is how this guide is set up. If it is not your style of learning, I recommend the paper <a href="https://academic.oup.com/aje/article/185/1/65/2662306">‚ÄúTargeted Maximum Likelihood Estimation for Causal Inference in Observational Studies‚Äù</a> by Megan S. Schuler and Sherri Rose, <a href="https://migariane.github.io/TMLE.nb.html">this online tutorial</a> by Miguel Angel Luque Fernandez, or the book <a href="https://link.springer.com/book/10.1007/978-1-4419-9782-1">‚ÄúTargeted Learning‚Äù</a> by Mark van der Laan and Sherri Rose.</p>
</div>
<div id="where-does-tmle-fit-into-the-field-of-causal-inference" class="section level1">
<h1>Where does TMLE fit into the field of causal inference?</h1>
<p>‚ÄúCausal inference is a complex scientific task that relies on triangulating evidence from multiple sources and on the application of a variety of methodological approaches. No book can possibly provide a comprehensive description of methodologies for causal inference across the sciences.‚Äù</p>
<p>-Miguel Hernan and James Robins, <em>Causal Inference, What If</em></p>
<p>If no book can possibly provide a comprehensive description of methodologies for causal inference, then one blog post certainly has no chance! However, I will go through a few main points of causal inference in an effort to show where TMLE fits into the vast field of causal inference.</p>
<ul>
<li><p><strong>Causal inference</strong> is, very generally, the process of <strong>using domain knowledge in combination with statistics to answer questions of ‚Äúwhat if‚Äù</strong> or ‚Äúwhat would have happened in a hypothetical world where we had done <em>this</em> instead of <em>that</em>?‚Äù</p></li>
<li><p>Many of the questions we seek to answer with statistical estimation models are causal in nature, even if we don‚Äôt claim our results to be causal answers. Causality is humankind‚Äôs natural way of thinking!</p></li>
<li><p>In medicine, the intuitive understanding of causal inference is that we want to make the estimates from our observational data look the same as if they came from data on a perfect, or ideal, randomized clinical trial.</p></li>
<li><p><strong>Causal inference is best thought of as a two-step process</strong>‚Ä¶ and only one of these steps involve data!</p></li>
</ul>
</div>
<div id="causal-inference-as-a-two-step-process" class="section level1">
<h1>Causal Inference as a two step process</h1>
<p><img src="/img/tmle/concepts_ci.png" />
<img src="/img/tmle/examples_ci.png" /></p>
</div>
<div id="why-should-i-bother-using-tmle" class="section level1">
<h1>Why should I bother using TMLE?</h1>
<p>I won‚Äôt try to fool you here ‚Äì the TMLE algorithm is not intuitive, and quite honestly can be very intimidating. However, the statistical properties that its estimates yield make it very much worth using.</p>
<p>The main idea is this: when performing research on observational data, we often want to quantify the effect of a treatment on an outcome. Too often, we find the treatment effect using statistical estimation models that assume unrealistic distributions for our data to solve this question. This can very easily lead to biased quantities for the treatment effect ‚Äì and those biases can potentially flip the interpretation of treatment effects from protective to harmful, or vice versa.</p>
<p>TMLE also, unlike many other propensity score methods, allows you to calculate valid confidence intervals. In methods like IPTW this is not the case becausse</p>
<p>In conclusion, we want to use TMLE to:</p>
<ul>
<li><p>avoid biased (sometimes very biased!) estimates of our treatment effect</p></li>
<li><p>respect the fact that we <em>have no idea</em> what the underlying distribution of our data (or the world) actually is</p></li>
<li></li>
</ul>
<p>Now, an introduction to the TMLE algorithm. If you start to feel very lost, this is just meant to explain <em>why</em> we‚Äôre doing all the steps in <a href="the%20TMLE%20algorithm">#the-tmle-algorithm</a>, and you can definitely skip this section for now.</p>
</div>
<div id="the-main-ideas-behind-the-tmle-algorithm" class="section level1">
<h1>The main ideas behind the TMLE algorithm</h1>
<p>The TMLE algorithm uses two estimates:</p>
<ol style="list-style-type: decimal">
<li><p>the estimated probability an indiviStep 6:
Take the average of the first set of updated prediction estimates from step 5. This can be interpreted as the expected outcome if all patients were to receive the treatment. Similarly, the average of the second updated prediction estimates from step 6 is the expected outcome if all patients had not received the treatment. The difference between those two quantities is the average treatment effectdual receives a treatment of interest, predicted by their baseline covariates (their propensity score)</p></li>
<li><p>the estimated outcome of an individual, predicted by their treatment and baseline covariates</p></li>
</ol>
<p>and uses those prediction estimates to estimate the average difference in outcomes if everyone had received the treatment, compared to if everyone had not received the treatment.</p>
<p>The main idea behind TMLE is to take a plain old estimating equation for the outcome given treatment and confounders, update, or <em>target</em> the treatment part of the equation using a variation of a propensity score. <strong>By <em>targeting</em> the effect of the treatment on the outcome, TMLE reduces bias and treatment imbalance that naturally exist in observational data, in a way that still optimizes the bias-variance tradeoff.</strong></p>
<p>The theoretical foundation of TMLE relies on what‚Äôs called <em>efficient influence functions</em>. If you have no idea what those are, don‚Äôt panic! You‚Äôve probably seen them before under a different name. For example, if you ever derived Maximum Likelihood Estimators in a probability theory class, you may remember that you take the derivative of the log-likelihood and get the score function. You then square it to get the Information Statistic, and the inverse of <em>that</em> is the Cramer Rao Lower Bound. That bound gives you the lowest possible variance for your MLE estimator as sample size approaches infinity.</p>
<p>In maximum likelihood estimation, the score function is the <em>influence function</em>, which can be intuitively defined as a way of estimating how much a new input has on a function‚Äôs output. The Cramer Rao Lower Bound inequality is the efficient influence function, which is defined as the influence function with the smallest variance matrix (if an efficient influence function exists). The Cramer Rao bound is a maximum likelihood estimator‚Äôs <em>efficiency bound</em>, which more generally is the lower bound on the variance of an estimator of a parameter.</p>
<p>What TMLE utlizes is called <em>semi-parametric efficient influence function theory</em>. This is because the idea behind TMLE is that we‚Äôre trying to estimate some parameter (in this post I‚Äôm only discussing the average treatment effect), we can treat all the other variables, or parameters, that go into that estimation as nuisance parameters (or parameters we really don‚Äôt care about their underlying probability distribution to estimate). Since TMLE <em>has</em> an efficient influence funtion, it also has an asymptotic lower bound on its variance.</p>
<p>and we can use it to find the efficient influence bound, or the worst ‚Ä¶ as sample size approaches infinity.</p>
<p>The efficient influence function œï
eff(X),
if it exists, is the influence function with the smallest variance matrix, which is why the Cramer Rao Lower Bound ‚Ä¶</p>
<p>Efficiency bounds (i.e., asymptotic lower bounds on variances of estimators of parameters) are of fundamental importance for semiparametric models.</p>
<p>What TMLE does is use</p>
<p>variance of your maximum likelihood estimate.</p>
<p>Influence functions, very generally, allow you to find a linear approximation to variance.</p>
<p>An extension to this idea is to use semi-parametric efficiency theory to find the influence functions for other equations that don‚Äôt have nice parameters like MLE.</p>
<p>This is why the TMLE algorithm seems so complicated when you‚Äôre first trying to learn it (or at least it did when I first tried to learn it!). We have to solve for the efficient influence function in order to 1) accurately target the treatment and 2) get a precise estimate of the variance.</p>
<p>The final estimate is for the ‚Äúaverage treatment effect,‚Äù which can be directly interpreted as the difference in outcomes if everyone had received the treatment compared to if everyone had not received the treatment.</p>
<p><strong>If you feel a bit lost, the wonderful news is that you don‚Äôt need a detailed understanding of the TMLE algorithm or its theoretical foundations as an applied statistician who wants to implement TMLE right now!</strong> However, it‚Äôs very interesting to understand it, and I‚Äôve tried to lay it out as simply as possible in the following step-by-step guide.</p>
<p>This guide is written the way I, and perhaps you too, think best as an applied statistician ‚Äì in words, visuals, data structures, and code. I have included the notation used in other explanations of TMLE next to my figures, but the steps are written so that it is not necessary to follow along with the equations.</p>
</div>
<div id="the-tmle-algorithm" class="section level1">
<h1>The TMLE Algorithm:</h1>
<p>Here we will look at the steps with pseudo-<code>R</code> code for a binary outcome and binary treatment. To see real <code>R</code> code on simulated data in another step-by-step explanation, check out <a href="https://migariane.github.io/TMLE.nb.html">this tutorial</a> by Miguel Angel Luque Fernandez.</p>
<div id="set-up" class="section level2">
<h2>Set-up</h2>
<p><img src="/img/tmle/tmle_setup.png" /></p>
</div>
<div id="the-initial-estimate" class="section level2">
<h2>The initial estimate:</h2>
<p><strong>Step 1:</strong> Estimate the probability of the outcome occurring using patients‚Äô treatment and baseline confounders as predictors.</p>
<pre class="r"><code>outcome_fit &lt;- fx(outcome ~
                     treatment +
                     confounder_1 +
                     confounder_2 +
                     ‚Ä¶ +
                     confounder_p)</code></pre>
<p>Then, use that estimating equation to predict everyone‚Äôs outcome with:</p>
<ol style="list-style-type: decimal">
<li>The original data set</li>
</ol>
<p><img src="/img/tmle/pred1.png" /></p>
<ol start="2" style="list-style-type: decimal">
<li><p>A data set where everyone receives the treatment
<img src="/img/tmle/pred2.png" /></p></li>
<li><p>A data set where no one receives the treatment</p></li>
</ol>
<p><img src="/img/tmle/pred3.png" /></p>
<p><em>Note:</em> if we were to stop here, our average treatment effect would just be the mean difference in the second and third predicted values. This type of estimation is called G-computation.</p>
</div>
<div id="gathering-the-information-to-update-our-estimate" class="section level2">
<h2>Gathering the information to update our estimate:</h2>
<p><strong>Step 2:</strong> Estimate the probability of receiving treatment, predicted by confounders (i.e.¬†propensity score), and then use that estimating equation to get two inverted predictions for every individual:</p>
<pre class="r"><code>treatment_fit &lt;- fx(treatment ~
                       confounder_1 +
                       confounder_2 +
                       ‚Ä¶ +
                       confounder_p)</code></pre>
<ol style="list-style-type: decimal">
<li>the inverse of the predicted probability for receiving treatment</li>
</ol>
<p><img src="/img/tmle/trt1.png" /></p>
<ol start="2" style="list-style-type: decimal">
<li>the negative inverse of the predicted probability for not receiving treatment</li>
</ol>
<p><img src="/img/tmle/trt-1.png" /></p>
<p><strong>Step 3:</strong> Use the predicted probabilities from step 2 to generate a new variable for every patient. In TMLE literature, this is called the clever covariate.
For patients who actually got treated, this clever covariate is the inverse of their predicted probability of treatment. For patients who did not get treated, this value is the negative inverse of their predicted probability of not receiving treatment.</p>
<p><strong>Step 4:</strong> Use a generalized linear model to predict everyone‚Äôs outcome. This model has only two components:</p>
<ol style="list-style-type: decimal">
<li><p>The predicted outcome under the treatment each patient actually received (from step 1) as a fixed intercept vector</p></li>
<li><p>Each person‚Äôs clever covariate from step 3 as the only predictor</p></li>
</ol>
<p>Once we‚Äôve fit that generalized linear model, we‚Äôll have an estimate for our one parameter, or predictor, and that‚Äôs a super important value! It helps us target our parameter of interest and optimize the bias-variance tradeoff. In TMLE literature, this constant is called <em>Epsilon</em>.</p>
<p>It‚Äôs worth noting here that the generalized linear model we‚Äôve fit here is just a tool for solving what‚Äôs called the ‚ÄúEfficient Estimating Equation,‚Äù which is the theoretical foundation of TMLE. Once we‚Äôve used it to solve for <em>Epsilon</em>, we‚Äôll have to back-transform using the link function so that we are on the original scale of our outcome.</p>
</div>
<div id="updating-our-initial-estimate" class="section level2">
<h2>Updating our initial estimate:</h2>
<p><strong>Step 5:</strong> Multiply Epsilon by the inverted treatment probabilities from step 2, and then add the corresponding treatment predictions from step 1.</p>
<p>All together, these quantities look like:</p>
<ol style="list-style-type: decimal">
<li><p><em>Epsilon</em> multiplied by the inverted predicted probability of receiving treatment, plus the predicted outcome from a data set where everyone received treatment</p></li>
<li><p><em>Epsilon</em> multiplied by the inverted predicted probability of not receiving treatment, plus the predicted outcome from a data set where no one received treatment</p></li>
</ol>
<p>Now, to get our updated, or targeted, prediction estimates for everyone, we need to use the link function from our generalized linear model (since we‚Äôre looking at a binary outcome here, it‚Äôs the logit link) and back-transform these quantities so they are on our original estimate scale.</p>
</div>
<div id="calculating-the-average-treatment-effect" class="section level2">
<h2>Calculating the average treatment effect:</h2>
<p><strong>Step 6:</strong> Take the average of the first set of updated prediction estimates from step 5. This can be interpreted as the expected outcome if all patients were to receive the treatment.</p>
<p>Similarly, the average of the second updated prediction estimates from step 6 is the expected outcome if all patients had not received the treatment.</p>
<p>The difference between those two quantities is the <em>average treatment effect</em>!</p>
</div>
<div id="calculating-the-variance" class="section level2">
<h2>Calculating the variance:</h2>
<p><strong>Step 7:</strong> Since we‚Äôre usually interested in the confidence we have in our estimate of a treatment effect, we need to calculate the variance. This could be done by bootstrapping, i.e.¬†repeat the TMLE algorithm thousands of times and taking the variance of the average treatment effect. However, there are theoretical properties of TMLE that allow us to calculate the variance using a simple equation:</p>
<p>This equation goes with the efficient influence function.</p>
</div>
</div>
<div id="why-should-i-bother-with-tmle" class="section level1">
<h1>Why should I bother with TMLE?</h1>
<p>Before I show an applied example of TMLE, I want to explain why I prefer TMLE to other propensity score estimation methods. In short, it is because because you don‚Äôt need to fit any certain type of regression to get your final estimates. You can use any estimator you want ‚Äì a generalized linear model, splines, random forests, gradient boosting, neural nets, honestly anything ‚Äì to get the initial probability estimates. You can actually use <em>all</em> of those estimators to get the two probability estimates, if you want! But more on that later.</p>
<p>The benefit of expanding your toolbox of potential estimators is that most estimators are built with prediction in mind, and thus yield very good probability estimates to initiate our TMLE algorithm. When our goal as statisticians is to calculate effects on an outcome attributable to a treatment, it‚Äôs easy to shy away from these prediction-focused types of estimators, because most of them do not have any statistical theory to allow us to calculate valid confidence intervals.</p>
<p><strong>A huge selling point of TMLE is that it allows you to utilize prediction-focused (often non-parametric) estimators, but still obtain valid confidence intervals on your final estimate of the treatment‚Äôs effect.</strong> TMLE utilizes concepts from semi-parametric influence function theory to determine valid standard errors, and therefore valid confidence intervals, on estimates of treatment effects. This is not important unless you plan to tackle the math of TMLE, but if you do decide to venture into technical explanations, know that you‚Äôll see references to influence functions <em>a lot</em>!</p>
<p>In other propensity score methods, like IPTW, we can only obtain valid confidence intervals if we obtain our propensity score using pre-specified parametric models. For example, we fit a logistic regression for our treatment predicted by five pre-specified baseline covariates. Using a logistic model like this to calculate the propensity score is not only placing a strong distributional assumption on our data, but it is limited in its ability to take in high-, or even medium-dimensional data. When we use estimators that are well equipped for very ‚Äúwide‚Äù data and perform variable selection, we obtain better overall estimates for our treatment effect of interest.</p>
<p>There are a few other major benefits to TMLE. For one, it has very good bias-variance properties, and those properties are ‚Äúrobust,‚Äù or ‚Äúresistant to‚Äù model mispecification, i.e.¬†having the wrong type of estimator or the wrong variables in your estimation of either the treatment or outcome. Another benefit is that if you are able to go through a causal identification process of the research question and available data (a concept I won‚Äôt discuss further, since it‚Äôs a separate realm of the problem), you‚Äôll have a causal interpretation of your average treatment effect estimate.</p>
</div>
<div id="a-real-world-application-of-tmle" class="section level1">
<h1>A Real World Application of TMLE</h1>
<pre class="r"><code>library(dplyr, warn.conflicts=F)
library(tmle)</code></pre>
<pre><code>## Loading required package: glmnet</code></pre>
<pre><code>## Loading required package: Matrix</code></pre>
<pre><code>## Loaded glmnet 3.0-2</code></pre>
<pre><code>## Loading required package: SuperLearner</code></pre>
<pre><code>## Loading required package: nnls</code></pre>
<pre><code>## Super Learner</code></pre>
<pre><code>## Version: 2.0-26</code></pre>
<pre><code>## Package created on 2019-10-27</code></pre>
<pre><code>## Welcome to the tmle package, version 1.4.0.1
## 
## Use tmleNews() to see details on changes and bug fixes</code></pre>
<p>Here I‚Äôll be using a data set from the ???. EXPLAIN DATA aND goal</p>
<p>I chose this data set because it is the same data used ‚ÄúThe Hitchhiker‚Äôs Guide to Targeted Learning,‚Äù which is a really good resource if you want to do a deeper dive in Targeted Learning. There is an update to the <code>tmle</code> package I‚Äôm showing here in the works right now called <code>tmle3</code>, so you can directly review the tutorial using this same data.</p>
<pre class="r"><code>washb_data &lt;- data.table::fread(&quot;https://raw.githubusercontent.com/tlverse/tlverse-data/master/wash-benefits/washb_data.csv&quot;,
                    stringsAsFactors = TRUE)</code></pre>
<p>Before we can run a TMLE analysis, we need to clean the data a bit. The <code>tmle</code> function requires a binary treatment, so I‚Äôll need to turn the treatment data from character strings to binary 0/1 variables. I‚Äôm only interested right now in women who recieved the treatment of Nutrition and Hand Washing, and comparing that to the Control women, so I‚Äôll filter out the appropriate subjects and make my data binary.</p>
<p>To use <code>tmle</code>, your data structure should be:</p>
<ul>
<li><p>Wide (each row is one observation)</p></li>
<li><p>No factors (all categorical variables should be transformed to dummy/indicator columns using a function like <code>model.matrix()</code></p></li>
<li><p>No missing data (I usually make a new column indicating whether the value was missing, and then impute at the mean or median for continuous variables)</p></li>
</ul>
<pre class="r"><code>dat_clean_tr &lt;- 
  washb_data %&gt;%
  filter(tr %in% c(&quot;Control&quot;, &quot;Nutrition + WSH&quot;)) %&gt;%
  mutate(tr = case_when(tr == &quot;Control&quot; ~ 0,
                        TRUE ~ 1))

dat_clean &lt;-
  dat_clean_tr %&gt;%
  mutate_at(vars(one_of(c(&quot;momage&quot;,&quot;momheight&quot;))), list(miss =~ ifelse(is.na(.), 1, 0))) %&gt;%
  mutate_at(vars(one_of(&quot;momage&quot;,&quot;momheight&quot;)), list( ~ ifelse(is.na(.), mean(., na.rm=T), .))) %&gt;%
  model.matrix(~ . + 0, data = .) %&gt;%
  as.data.frame()</code></pre>
<p>Once I‚Äôve cleaned my data, I make vectors specifying my treatment, outcome, and baseline covariates. In the TMLE literature, and in this package, the notations are:</p>
<ul>
<li><p>Outcome: <code>Y</code></p></li>
<li><p>Treatment: <code>A</code></p></li>
<li><p>Confounders: <code>W</code></p></li>
</ul>
<p>In this data set, our outcome is the variable <code>whz</code>, our treatment is the variable <code>tr</code>, and our baseline confounders are all the other variables in our data set.</p>
<pre class="r"><code>Y &lt;- dat_clean$whz
A &lt;- dat_clean$tr
W &lt;- dat_clean %&gt;% dplyr::select(-whz, -tr)</code></pre>
<p>Once we‚Äôve done that, we can get our TMLE estimate of the average treatment effect! Here, I‚Äôm only inputting the</p>
<pre class="r"><code>tmlefit_default &lt;- tmle::tmle(Y, A, W)
tmlefit_default</code></pre>
<p>Now, I‚Äôm going to specify the kinds of estimators I want to use to get my two initial estimates: the expected outcome and the probability of the exposure.</p>
<p>I‚Äôve chosen to call the functions <code>glm</code> for a generalized linear model, <code>glmnet</code> for penalized regression, <code>ranger</code> for random forests, and <code>xgboost</code> for extreme gradient boosting.</p>
<p>I‚Äôm going to use <em>all</em> of these estimators to estimate the</p>
<pre class="r"><code>SL_library &lt;- c(&quot;SL.glm&quot;,
                &quot;SL.glmnet&quot;,
                &quot;SL.ranger&quot;,
                &quot;SL.xgboost&quot;)</code></pre>
<p>We‚Äôre going to specify those libraries in the arguments <code>Q.SL.library</code> and <code>g.SL.library</code>. These arguments sound a bit scary, but they are just what the notation in TMLE literature is ‚Äì Q refers to the estimation for the outcome given treatment and covariates, and g refers to the estimation of the probability of the treatment.</p>
<pre class="r"><code>tmlefit &lt;- tmle::tmle(Y, A, W,
                Q.SL.library = SL_library, g.SL.library = SL_library)
tmlefit</code></pre>
<p>To understand how the various machine learning models are combining, you should look into a type of ensemble learning called stacking, or ‚Äúsuperlearning.‚Äù I have a slideshow that you could look at <a href="https://github.com/hoffmakl/sl3-demo/blob/master/superlearning_slides_no_animation.pdf">here</a>, but there are plenty of other resources online.</p>
<p>This is obviously not a super technical post, and it was not intended to be, but I hope that it may catch your interest to learn more about the complexities of TMLE and try it out in your next analysis. I plan to write a few similar posts on what to do if your outcomes are survival or longitudinal data. In the meantime, you may find the more technical tutorial on TMLE helpful:</p>
<p>or, ‚ÄúThe Hitchiker‚Äôs Guide to Targeted Learning‚Äù is an excellent, still-in-progress, resource for learning TMLE and many other targeted learning.</p>
<p>Learn about causal inference,</p>
<p>we should be estimating answers for questions of actual interest, rather than debiasing our results.</p>
</div>
<div id="references" class="section level1">
<h1>References:</h1>
<ul>
<li><p>When performing research on observational data, we often want to quantify the effect of an exposure, or treatment, on an outcome. Too often, we find the treatment effect using statistical estimation models that assume unrealistic distributions for our data to solve this question. This leads to biased quantities for the treatment effect ‚Äì and those biases can potentially flip treatments from qualitatively protective to harmful, or vice versa.</p></li>
<li><p>The most basic form of Targeted Maximum Likelihood Estimation (TMLE) allows you to calculate the average treatment effect using estimates of:</p>
<ol style="list-style-type: decimal">
<li><p>the expected outcome for an individual, given the treatment they received and their baseline confounders</p></li>
<li><p>the probability an individual received the treatment of interest, given their baseline confounders (a propensity score)</p></li>
</ol></li>
<li><p>TMLE has been proven, both mathematically and via simulation studies, to have an optimal bias-variance tradeoff for calculating the average treatment effect. It remains an unbiased estimator even if one of the two above estimating equations are incorrect.</p></li>
<li><p>Additionally, the two aforementioned estimates can come from multiple machine learning models, thereby eliminating many underlying distribution assumptions, but the overall estimate of the treatment effect will still have valid confidence intervals.</p></li>
<li><p>The algorithm is complex but can be understood <a href="#the-tmle-algorithm">through a series of steps</a>. The <code>R</code> packages <code>tmle</code> or <code>tmle3</code> make it easy to quickly implement TMLE. An <a href="#a-real-world-application-of-tmle">example analysis with code</a> is at the end of this post.</p></li>
</ul>
<hr />
<p>For broader introductions to causal inference, I like both Judea Pearl‚Äôs <a href="http://bayes.cs.ucla.edu/PRIMER/">‚ÄúCausal Inference in Statistics: A Primer‚Äù</a> and Miguel Hernan and James Robins‚Äô <a href="https://cdn1.sph.harvard.edu/wp-content/uploads/sites/1268/2019/11/ci_hernanrobins_10nov19.pdf">‚ÄúCausal Inference: What If‚Äù</a> books.</p>
</div>

    </div>

    


    

<div class="article-tags">
  
  <a class="badge badge-light" href="/tags/r/">R</a>
  
</div>



    
      








  





  
  
  
    
  
  
  <div class="media author-card" itemscope itemtype="http://schema.org/Person">
    
      
      <img class="portrait mr-3" src="/authors/admin/avatar_hub64370a9fa8c7276c9d6cc9d2e350075_235979_250x250_fill_q90_lanczos_center.jpg" itemprop="image" alt="Avatar">
    

    <div class="media-body">
      <h5 class="card-title" itemprop="name"><a href="/">Katherine Hoffman</a></h5>
      <h6 class="card-subtitle">Research Biostatistician I</h6>
      <p class="card-text" itemprop="description">I am passionate about meaningful, reproducible medical research.</p>
      <ul class="network-icon" aria-hidden="true">
        
          
          
          
            
          
          
          
          
          
            
          
          <li>
            <a itemprop="sameAs" href="/#contact" >
              <i class="fas fa-envelope"></i>
            </a>
          </li>
        
          
          
          
            
          
          
          
          
          
            
          
          <li>
            <a itemprop="sameAs" href="https://twitter.com/Rkatlady" target="_blank" rel="noopener">
              <i class="fab fa-twitter"></i>
            </a>
          </li>
        
          
          
          
            
          
          
          
          
          
            
          
          <li>
            <a itemprop="sameAs" href="https://github.com/hoffmakl" target="_blank" rel="noopener">
              <i class="fab fa-github"></i>
            </a>
          </li>
        
      </ul>
    </div>
  </div>



      
      
      <div class="article-widget">
        <div class="hr-light"></div>
        <h3>Related</h3>
        <ul>
          
          <li><a href="/blog/sl/superlearning/">Become a Superlearner! A visual guide to the superlearner algorithm &#43; demo of {sl3}</a></li>
          
          <li><a href="/blog/tmle-tutorial/tmle-tutorial-3/">UPDATE An Equation-Free Explanation of Targeted Maximum Likelihood Estimation (TMLE)</a></li>
          
          <li><a href="/blog/tmle-tutorial/tmle-tutorial/">An Equation-Free Explanation of Targeted Maximum Likelihood Estimation (TMLE)</a></li>
          
          <li><a href="/blog/power-sims/power-sims/">Writing your own Power Simulations in R</a></li>
          
          <li><a href="/blog/trt-timelines/trt-timelines/">Patient Treatment Timelines for Longitudinal Survival Data</a></li>
          
        </ul>
      </div>
      
    

    

    


  </div>
</article>

      

    
    

    
    
    
      <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js" integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo=" crossorigin="anonymous"></script>
      <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery.imagesloaded/4.1.4/imagesloaded.pkgd.min.js" integrity="sha256-lqvxZrPLtfffUl2G/e7szqSvPBILGbwmsGE1MKlOi0Q=" crossorigin="anonymous"></script>
      <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery.isotope/3.0.6/isotope.pkgd.min.js" integrity="sha256-CBrpuqrMhXwcLLUd5tvQ4euBHCdh7wGlDfNz8vbu/iI=" crossorigin="anonymous"></script>
      <script src="https://cdnjs.cloudflare.com/ajax/libs/fancybox/3.2.5/jquery.fancybox.min.js" integrity="sha256-X5PoE3KU5l+JcX+w09p/wHl9AzK333C4hJ2I9S5mD4M=" crossorigin="anonymous"></script>

      

      
        
        <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.15.6/highlight.min.js" integrity="sha256-aYTdUrn6Ow1DDgh5JTc3aDGnnju48y/1c8s1dgkYPQ8=" crossorigin="anonymous"></script>
        
        <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.15.6/languages/r.min.js"></script>
        
      

      
      
    

    
    

    
    
    <script>hljs.initHighlightingOnLoad();</script>
    

    
    
    <script>
      const search_index_filename = "/index.json";
      const i18n = {
        'placeholder': "Search...",
        'results': "results found",
        'no_results': "No results found"
      };
      const content_type = {
        'post': "Posts",
        'project': "Projects",
        'publication' : "Publications",
        'talk' : "Talks"
        };
    </script>
    

    
    

    
    
    <script id="search-hit-fuse-template" type="text/x-template">
      <div class="search-hit" id="summary-{{key}}">
      <div class="search-hit-content">
        <div class="search-hit-name">
          <a href="{{relpermalink}}">{{title}}</a>
          <div class="article-metadata search-hit-type">{{type}}</div>
          <p class="search-hit-description">{{snippet}}</p>
        </div>
      </div>
      </div>
    </script>
    

    
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/fuse.js/3.2.1/fuse.min.js" integrity="sha256-VzgmKYmhsGNNN4Ph1kMW+BjoYJM2jV5i4IlFoeZA9XI=" crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/mark.js/8.11.1/jquery.mark.min.js" integrity="sha256-4HLtjeVgH0eIB3aZ9mLYF6E8oU5chNdjU6p6rrXpl9U=" crossorigin="anonymous"></script>
    

    
    

    
    

    
    
    
    
    
    
    
    
    
      
    
    
    
    
    <script src="/js/academic.min.16bbb3750feb7244c9bc409a5a4fe678.js"></script>

    






  
  <div class="container">
    <footer class="site-footer">
  
  <p class="powered-by">
    
      <a href="/privacy/">Privacy Policy</a>
    
    
       &middot; 
      <a href="/terms/">Terms</a>
        
  </p>
  

  <p class="powered-by">
    

    Powered by the
    <a href="https://sourcethemes.com/academic/" target="_blank" rel="noopener">Academic theme</a> for
    <a href="https://gohugo.io" target="_blank" rel="noopener">Hugo</a>.

    
    <span class="float-right" aria-hidden="true">
      <a href="#" id="back_to_top">
        <span class="button_icon">
          <i class="fas fa-chevron-up fa-2x"></i>
        </span>
      </a>
    </span>
    
  </p>
</footer>

  </div>
  

  
<div id="modal" class="modal fade" role="dialog">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Cite</h5>
        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body">
        <pre><code class="tex hljs"></code></pre>
      </div>
      <div class="modal-footer">
        <a class="btn btn-outline-primary my-1 js-copy-cite" href="#" target="_blank">
          <i class="fas fa-copy"></i> Copy
        </a>
        <a class="btn btn-outline-primary my-1 js-download-cite" href="#" target="_blank">
          <i class="fas fa-download"></i> Download
        </a>
        <div id="modal-error"></div>
      </div>
    </div>
  </div>
</div>

</body>
</html>
