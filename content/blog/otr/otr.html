---
title: "Building Statistical Intuition for Optimal Individualized Treatment Rules"
author: "Katherine Hoffman"
date: 2022-07-19T00:01:14-02:00
draft: fale
categories: ["statistics","R"]
math: true
tags: ["statistics","R","personalized medicine","heterogenous treatment effects"]
output:
  blogdown::html_page:
    toc: false
    toc_depth: 1
---



<p><strong>Individualized treatment rules (ITRs)</strong> is a fast-growing topic in the medical research community. A treatment rule is a <strong>decision for treatment based upon a patient‚Äôs characteristics</strong>. The intuition behind this is that not all patients will respond to a treatment in the same way. We can exploit these <strong>heterogeneous effects</strong> and develop personalized rules which provide benefit to the most individuals.</p>
<p>Developing and optimizing treatment rules is rooted in <strong>principles of causal inference</strong>, or using data to inform us about what would have happened in a hypothetical world in which different interventions had occurred. This post walks through the basic statistical intuition for ITRs. Each explanation is accompanied by mathematical notation and a small graphic to convey equivalent meanings.</p>
<blockquote>
<p>Although this post is introductory, it assumes basic knowledge in causal inference, such as <em>counterfactual outcomes</em>, <em>assumptions for causal identification</em>, <em>Average Treatment Effect</em>, and <a href="https://github.com/kathoffman/causal-inference-visual-guides/blob/master/visual-guides/G-Computation.pdf"><em>G-computation</em></a>. If you‚Äôre rusty on these concepts, I recommend reading the freely available introductory chapters of Miguel Hernan and James Robins‚Äô <a href="https://www.hsph.harvard.edu/miguel-hernan/causal-inference-book/"><em>What If</em></a> book.</p>
</blockquote>
<div id="table-of-contents" class="section level1">
<h1>Table of Contents</h1>
<ol style="list-style-type: decimal">
<li><p>üó∫Ô∏è <a href="#the-big-picture-of-itrs">The big-picture approach to ITRs</a></p></li>
<li><p>üìà <a href="#estimating-the-itr">A simple estimation example</a></p></li>
<li><p>üñ•Ô∏è <a href="#r-simulation"><code>R</code> code for a simple estimation example</a></p></li>
</ol>
<!-- # This post builds on the following concepts: -->
<!-- - **Counterfactual outcome**: the outcome in a hypothetical world where a unit received a certain intervention or treatment, which might be different from the treatment they actually received. -->
<!-- - Average Treatment Effect:  -->
<!-- - **G-computation:** a form of substitution estimation. In its simplest form for computing the ATE for a binary treatment, the G-comp procedure is: -->
<!--   1. fit a regression for $\mathrm{E}[Y|A,W]$ -->
<!--   2. obtain predictions for $\hat{E}[Y|A,W]$ when $A=1$ and $A=0$ -->
<!--   3. take the average difference between $\hat{E}[Y|A=1,W]$ and $\hat{E}[Y|A=0,W]$ -->
<!-- # The FUTURE of Medicine -->
</div>
<div id="the-big-picture-of-itrs" class="section level1">
<h1>üó∫Ô∏è The Big Picture of ITRs</h1>
<p>Let‚Äôs first think through the general concept of developing and optimizing an ITR.</p>
<ol style="list-style-type: decimal">
<li>We will start with a standard set-up: we have a matrix of observed data <span class="math inline">\(O\)</span> which includes our <strong>outcome</strong> <span class="math inline">\(Y\)</span>, the <strong>exposure</strong> (i.e.¬†treatment, medicine, etc.) we want to study <span class="math inline">\(A\)</span>, and other <strong>covariates</strong> <span class="math inline">\(W\)</span>. We can denote these random variables as <span class="math inline">\(O = (W, A, Y)\)</span>.</li>
</ol>
<p><img src="/img/otr/data_structure.png" style="width:80.0%" /></p>
<!-- , and visualize it as the following data set. *Note that we are considering a binary exposure for simplicity.* -->
<!-- ![](/img/tmle/1_data_structure.png){width=80%} -->
<ol start="2" style="list-style-type: decimal">
<li>Now, consider that we‚Äôve created some function, <span class="math inline">\(d\)</span>, which takes baseline confounders <span class="math inline">\(W\)</span> and outputs a treatment assignment <span class="math inline">\(A\)</span>. We can write this mapping function, or <strong>treatment rule</strong>, in mathematical notation as:</li>
</ol>
<!-- <p style="margin-left: 40px"> -->
<p><span class="math display">\[d: W \rightarrow A\]</span>
This is equivalent to a function you could write in R or Python which takes a data frame <code>W</code> and outputs a vector of treatment assignments <code>A</code>.</p>
<p><img src="/img/otr/input_output.png" style="width:80.0%" /></p>
<!-- <p style="margin-left: 40px">An example in `R` code could be this:</p>  -->
<!-- <p style="margin-left: 40px"> -->
<!-- ```{r} -->
<!-- d <- function(W){ -->
<!--   # assigned treatment A is a vector of length nrow(W) and depends on values of W -->
<!--   # for example, the treatment rule could be if W1 is greater than 5, treat, otherwise, don't treat -->
<!--   A <- ifelse(W[[1]] > 5, 1, 0) -->
<!--   return(A) -->
<!-- } -->
<!-- ``` -->
<!-- </p>  -->
<ol start="3" style="list-style-type: decimal">
<li>We can then think about the <strong>counterfactual outcome</strong><a href="#fn1" class="footnote-ref" id="fnref1"><sup>1</sup></a> for each row, or observation, under the treatment rule <span class="math inline">\(d\)</span>. In other words, we are asking <em>what would have happened in the hypothetical world in which the treatment rule <span class="math inline">\(d\)</span> was applied?</em></li>
</ol>
<p>Let‚Äôs denote this vector of counterfactual outcomes as <span class="math inline">\(Y(d)\)</span>.</p>
<p><img src="/img/otr/Y_d.png" style="width:100.0%" /></p>
<ol start="4" style="list-style-type: decimal">
<li>The optimal ITR will <strong>maximize the expected counterfactual outcome</strong>, or <span class="math inline">\(\mathrm{E}[Y(d)]\)</span>, across the entire population. We can write that using <span class="math inline">\(\mathop{\mathrm{arg\,max}}\)</span>, which means we want to know which argument will return the highest value of a function. In this use-case, we want to know what treatment rule <span class="math inline">\(d\)</span> returns the highest expected value of the counterfactual outcome, <span class="math inline">\(\mathrm{E}[Y(d)]\)</span>.</li>
</ol>
<p><span class="math display">\[\mathop{\mathrm{arg\,max}}_d \mathrm{E}[Y(d)]\]</span></p>
<p><img src="/img/otr/argmax.png" style="width:70.0%" /></p>
<ol start="5" style="list-style-type: decimal">
<li>We‚Äôll call whatever function <span class="math inline">\(d\)</span>, or <span class="math inline">\(d(W)\)</span>, that maximizes this expected counterfactual outcome for the population <span class="math inline">\(d^*(W)\)</span>. <strong>This <span class="math inline">\(d^*(W)\)</span> is our optimal ITR.</strong></li>
</ol>
<p><img src="/img/otr/d_star.png" style="width:50.0%" /></p>
</div>
<div id="estimating-the-itr" class="section level1">
<h1>üìà Estimating the ITR</h1>
<p>There are many ways to estimate <span class="math inline">\(d^*(W)\)</span>. One of the most common ways begins by estimating the <strong>Conditional Average Treatment Effect (CATE)</strong>.</p>
<p>You have probably heard of the Average Treatment Effect (ATE), which is the mean difference in outcomes in a world in which every unit receives the exposure compared to a world in which no unit receives the exposure. In potential outcomes notation, <span class="math inline">\(ATE = \mathrm{E}[Y^1-Y^0]\)</span>. The CATE is the same formula and description, but within covariate strata <span class="math inline">\(W\)</span>.</p>
<p><span class="math display">\[CATE = \mathrm{E}[Y^1-Y^0|W]\]</span></p>
<p>Under standard causal assumptions<a href="#fn2" class="footnote-ref" id="fnref2"><sup>2</sup></a>, the CATE for a binary exposure is identifiable under the following formula:</p>
<p><span class="math display">\[\mathrm{CATE}(W) = \mathrm{E}[Y|A=1, W] - \mathrm{E}[Y|A=0, W]\]</span>
<!-- Compare this to the ATE after identification to clearly see the formula for CATE is the same, minus the outer expectation: --></p>
<!-- $$\mathrm{ATE}(W) = \mathrm{E}[\mathrm{E}[Y|A=1, W] - \mathrm{E}[Y|A=0, W]]$$ -->
<p>We could estimate the CATE using <strong>G-computation</strong>. If you‚Äôd like a review on G-computation, check out this <a href="https://github.com/kathoffman/causal-inference-visual-guides/blob/master/visual-guides/G-Computation.pdf">visual guide</a>.</p>
<ol style="list-style-type: decimal">
<li>Fit a regression for <span class="math inline">\(\mathrm{E}[Y|A,W]\)</span>.</li>
</ol>
<p><img src="/img/tmle/2_outcome_fit.png" style="width:70.0%" /></p>
<ol start="2" style="list-style-type: decimal">
<li>Obtain predicted estimates for <span class="math inline">\(Y\)</span> on datasets where all observations are changed to have <span class="math inline">\(A=1\)</span> and <span class="math inline">\(A=0\)</span> using the model fit from Step 1.</li>
</ol>
<p><span class="math display">\[\hat{E}[Y|A=1, W]\]</span></p>
<p><img src="/img/tmle/4_Q1.png" style="width:80.0%" /></p>
<p><span class="math display">\[\hat{E}[Y|A=0, W]\]</span></p>
<p><img src="/img/tmle/5_Q1.png" style="width:80.0%" /></p>
<ol start="3" style="list-style-type: decimal">
<li>Compute the difference in the predicted <span class="math inline">\(Y\)</span>‚Äôs for the two datasets from Step 2.</li>
</ol>
<p><span class="math display">\[\widehat{CATE}(W) = \hat{E}[Y|A=1, W] - \hat{E}[Y|A=0, W]\]</span></p>
<p><img src="/img/otr/cate.png" style="width:32.0%" /></p>
<p>Then, we could say our optimal ITR is to <strong>give treatment if the value of <span class="math inline">\(CATE(W)\)</span> for that person is positive</strong>, indicating a positive effect of treatment on the outcome <span class="math inline">\(Y\)</span>. Likewise, if the value is negative or 0, indicating a negative or neutral effect on the outcome <span class="math inline">\(Y\)</span>, that unit would not receive treatment under the ITR.</p>
<p><span class="math display">\[ \mathrm{ITR}(W) = \mathbb{1}{ \{\mathrm{CATE}(W) &gt; 0} \}\]</span></p>
<p><img src="/img/otr/cate_assign_legend.png" style="width:50.0%" /></p>
</div>
<div id="r-simulation" class="section level1">
<h1>üñ•Ô∏è <code>R</code> simulation</h1>
<p>Let‚Äôs take a look an <code>R</code> simulation for the simple estimation of <span class="math inline">\(d^*(W)\)</span> we just described. We can first simulate data of <code>n</code> = 500 rows, where we have only one confounder <code>W</code>, a binary treatment <code>A</code> which depends on <code>W</code>, and an outcome <code>Y</code> which is continuous and depends on <code>W</code> and <code>A</code>.</p>
<pre class="r"><code>n &lt;- 500
W &lt;- runif(n, 1, 99)
A &lt;- rbinom(n, 1, prob = abs(W/100))
Y &lt;- rnorm(n, 10) + rnorm(n, 2*A) + rnorm(n, 50*W) - rnorm(n, .1*A*W)
df &lt;- data.frame(W, A, Y)</code></pre>
<p>We‚Äôll run a regression for a saturated linear regression model of <span class="math inline">\(\mathrm{E}[Y|A,W]\)</span>, then obtain predictions on datasets where <code>A</code> is changed to <code>1</code> and <code>0</code> for all rows. We can then compute the CATE as the difference between these predictions.</p>
<pre class="r"><code>fit &lt;- glm(Y~A*W)
E_Y1 &lt;- predict(fit, newdata = data.frame(A = 1, W))
E_Y0 &lt;- predict(fit, newdata = data.frame(A = 0, W))
CATE &lt;- E_Y1 - E_Y0</code></pre>
<p>Finally, our optimal treatment rule will be to treat any unit with <code>CATE &gt; 1</code>. We can visually see there is benefit for about 1/4 of units in our simulated population.</p>
<pre class="r"><code>library(tidyverse)
data.frame(CATE) |&gt;
  mutate(d_star = ifelse(CATE &gt; 0, &quot;Treat&quot;, &quot;Do not treat&quot;)) |&gt;
  ggplot(aes(CATE, fill=d_star)) +
  geom_histogram(binwidth=.2) +
  theme_bw() +
  scale_fill_manual(values = c(&quot;#f2696f&quot;,&quot;#4984b0&quot;)) +
  labs(x=&quot;CATE(W)&quot;, y = &quot;Count&quot;, fill = &quot;Treatment Rule&quot;, title=&quot;Distribution of CATE(W)&quot;)</code></pre>
<p><img src="/blog/otr/otr_files/figure-html/unnamed-chunk-3-1.png" width="672" /></p>
</div>
<div id="improving-estimation-of-dw" class="section level1">
<h1>Improving estimation of <span class="math inline">\(d^*(W)\)</span></h1>
<p>There are more advanced ways to estimate <span class="math inline">\(CATE(W)\)</span> using data-adaptive machine learning techniques and obtaining improved statistical properties, e.g.¬†<strong>double robustness</strong>. We could also estimate <span class="math inline">\(d^*(W)\)</span> directly instead of first estimating <span class="math inline">\(CATE(W)\)</span>.</p>
<p>We can extend either of these ideas to longitudinal settings, studies with clustering, etc. I‚Äôve listed some of the resources I am reading to learn about optimizing ITRs below. As always I welcome feedback and/or suggestions of additional resources I can include.</p>
</div>
<div id="further-reading" class="section level1">
<h1>Further reading</h1>
<p>These concepts are introductory, so any paper on ‚Äúoptimal treatment rules‚Äù, ‚Äúindividualized treatment rules‚Äù, or ‚Äúheterogeneous treatment effects‚Äù should review the ideas discussed here in their introductions.</p>
<ul>
<li><p>This <a href="https://www.bios.unc.edu/~dzeng/Pub/EHROLearning1.pdf">Wang et al.¬†paper</a> offers a very clear introduction on ITRs.</p></li>
<li><p>Lately I‚Äôve been interested in <a href="https://arxiv.org/pdf/2004.14497.pdf">this recent paper</a> by Edward Kennedy discusses one way to evaluate the CATE using doubly robust methods, and gives several other foundational papers in the introduction.</p></li>
<li><p><a href="https://egap.org/resource/10-things-to-know-about-heterogeneous-treatment-effects/">This <code>R</code> blog post</a> about heterogeneous treatment effects also may be useful for thinking through these issues with real data.</p></li>
</ul>
<p>I‚Äôll continue to add resources to this list as I discover them. Please reach out if you have recommendations of papers or tutorials (yours or others!) to add to this list.</p>
<div id="acknowledgments" class="section level2">
<h2>Acknowledgments</h2>
<p>Thanks to my colleague <a href="https://twitter.com/ildiazm">Iv√°n D√≠az</a> for explaining optimal individualized treatment rules to me in this way, and for reviewing this post.</p>
</div>
</div>
<div class="footnotes footnotes-end-of-document">
<hr />
<ol>
<li id="fn1"><p>Recall that a counterfactual describes a hypothetical world where a unit received a certain intervention or treatment, which might be different from the treatment they actually received<a href="#fnref1" class="footnote-back">‚Ü©Ô∏é</a></p></li>
<li id="fn2"><p>This post is focused on estimation and therefore does not detail the requirements for causal identification, but here I refer to the assumptions of consistency, exchangeability, and positivity.<a href="#fnref2" class="footnote-back">‚Ü©Ô∏é</a></p></li>
</ol>
</div>
